<Window x:Class="Sleipnir.App.Views.UserPermissionsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Sleipnir.App.Views"
        xmlns:utils="clr-namespace:Sleipnir.App.Utils"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        mc:Ignorable="d"
        Title="User Permissions" Height="500" Width="400"
        WindowStartupLocation="CenterOwner"
        WindowStyle="None"
        AllowsTransparency="False"
        Background="#0F111A"
        BorderBrush="#30363D"
        BorderThickness="1">

    <Window.Resources>
        <utils:BooleanInverseConverter x:Key="BooleanInverseConverter" />
        <utils:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <utils:BooleanToVisibilityInverseConverter x:Key="BooleanToVisibilityInverseConverter"/>
        <utils:StringContainsMultiConverter x:Key="StringContainsMultiConverter"/>
        <utils:MultiSelectionConverter x:Key="MultiSelectionConverter"/>
    </Window.Resources>

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="32" ResizeBorderThickness="5" GlassFrameThickness="0" CornerRadius="0"/>
    </WindowChrome.WindowChrome>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <Border Grid.Row="0" Background="#141724" Height="32" BorderBrush="#30363D" BorderThickness="0,0,0,1">
            <Grid>
                <StackPanel Orientation="Horizontal" Margin="15,0,0,0">
                    <iconPacks:PackIconMaterial Kind="ShieldAccount" Width="14" Height="14" Foreground="#7C4DFF" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="Edit User Rights" VerticalAlignment="Center" Foreground="#8B949E" FontSize="12"/>
                </StackPanel>
                <Button HorizontalAlignment="Right" Content="âœ•" Style="{StaticResource WindowCloseButton}" Click="Close_Click" WindowChrome.IsHitTestVisibleInChrome="True"/>
            </Grid>
        </Border>

        <!-- Content -->
        <ScrollViewer Grid.Row="1" Padding="25">
            <StackPanel>
                <!-- User Info Info Header -->
                <Grid Margin="0,0,0,25">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <Border Width="50" Height="50" CornerRadius="25" Background="#2A2F45" Margin="0,0,15,0">
                        <iconPacks:PackIconMaterial Kind="{Binding Emoji, FallbackValue=Account}" Width="28" Height="28" Foreground="White" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                    </Border>
                    
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="{Binding FullName}" FontSize="18" FontWeight="Bold" Foreground="White"/>
                        <TextBlock Text="{Binding Username}" FontSize="12" Foreground="#8B949E"/>
                    </StackPanel>
                </Grid>

                <Separator Background="#30363D" Margin="0,0,0,20"/>

                <!-- Admin Status -->
                <TextBlock Text="ADMINISTRATIVE RIGHTS" FontSize="11" FontWeight="Bold" Foreground="#7C4DFF" Margin="0,0,0,15"/>
                
                <Border Background="#1C1F30" CornerRadius="8" Padding="15" Margin="0,0,0,25">
                    <StackPanel>
                        <CheckBox IsChecked="{Binding IsSuperuser}" Content="Administrator Access" Foreground="White" FontWeight="Bold" Margin="0,0,0,5"
                                  IsEnabled="{Binding IsOriginalAdmin, Converter={StaticResource BooleanInverseConverter}}"/>
                        <TextBlock Text="Grants full access to all projects, settings, and user management." 
                                   FontSize="10" Foreground="#8B949E" TextWrapping="Wrap" Margin="30,0,0,0"/>
                    </StackPanel>
                </Border>

                <!-- Granular Permissions -->
                <TextBlock Text="GRANULAR AREA ACCESS" FontSize="11" FontWeight="Bold" Foreground="#7C4DFF" Margin="0,0,0,15"/>
                
                <Border Background="#1C1F30" CornerRadius="8" Padding="15" Margin="0,0,0,25"
                        IsEnabled="{Binding IsSuperuser, Converter={StaticResource BooleanInverseConverter}}">
                    <StackPanel>
                        <CheckBox IsChecked="{Binding CanAccessBacklog}" Content="Backlog &amp; Board" Foreground="White" Margin="0,0,0,12"/>
                        <CheckBox IsChecked="{Binding CanAccessPipeline}" Content="Pipeline (Stories)" Foreground="White" Margin="0,0,0,12"/>
                        <CheckBox IsChecked="{Binding CanAccessHub}" Content="Hub (Epics)" Foreground="White" Margin="0,0,0,12"/>
                        <CheckBox IsChecked="{Binding CanAccessSettings}" Content="Settings &amp; Admin Actions" Foreground="White"/>
                    </StackPanel>
                </Border>

                <!-- Project Access -->
                <TextBlock Text="PROJECT ACCESS" FontSize="11" FontWeight="Bold" Foreground="#7C4DFF" Margin="0,0,0,15"
                           Visibility="{Binding IsSuperuser, Converter={StaticResource BooleanToVisibilityInverseConverter}}"/>

                <Border Background="#1C1F30" CornerRadius="8" Padding="15" Margin="0,0,0,25"
                        Visibility="{Binding IsSuperuser, Converter={StaticResource BooleanToVisibilityInverseConverter}}">
                    <ScrollViewer MaxHeight="150" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding ViewModel.Projects, RelativeSource={RelativeSource AncestorType=Window}}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <ToggleButton Content="{Binding Name}" Margin="0,0,6,6" Padding="10,5" FontSize="11"
                                                  Style="{StaticResource SidebarToggleButton}">
                                        <ToggleButton.IsChecked>
                                            <MultiBinding Converter="{StaticResource StringContainsMultiConverter}" Mode="OneWay">
                                                <Binding Path="DataContext.AllowedProjectIds" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                <Binding Path="Id"/>
                                            </MultiBinding>
                                        </ToggleButton.IsChecked>
                                        <ToggleButton.Command>
                                            <Binding Path="ViewModel.ToggleProjectAccessCommand" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                        </ToggleButton.Command>
                                        <ToggleButton.CommandParameter>
                                            <MultiBinding Converter="{StaticResource MultiSelectionConverter}">
                                                <Binding Path="DataContext" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                <Binding Path="."/>
                                            </MultiBinding>
                                        </ToggleButton.CommandParameter>
                                    </ToggleButton>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>

                <!-- System / Login -->
                <TextBlock Text="SYSTEM SETTINGS" FontSize="11" FontWeight="Bold" Foreground="#7C4DFF" Margin="0,0,0,15"/>
                
                <Border Background="#1C1F30" CornerRadius="8" Padding="15" Margin="0,0,0,10">
                    <StackPanel>
                        <CheckBox IsChecked="{Binding CanAutoLogin}" Content="Enable Auto-Login" Foreground="White" Margin="0,0,0,5"/>
                        <TextBlock Text="Allows the application to log in automatically." 
                                   FontSize="10" Foreground="#8B949E" TextWrapping="Wrap" Margin="30,0,0,0"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Footer -->
        <Border Grid.Row="2" Background="#141724" Padding="20" BorderBrush="#30363D" BorderThickness="0,1,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="Cancel" Style="{StaticResource SidebarButton}" Width="100" Click="Close_Click" Margin="0,0,10,0"/>
                <Button Content="Save Rights" Style="{StaticResource AccentButton}" Width="130" Click="Save_Click"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
