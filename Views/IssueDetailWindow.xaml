<Window x:Class="Sleipnir.App.Views.IssueDetailWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Sleipnir.App.Views"
        mc:Ignorable="d"
        Title="Sleipnir | Issue Details" Height="600" Width="800"
        Icon="/Resources/sleipnir.ico"
        Background="#0F111A"
        WindowStartupLocation="CenterScreen"
        WindowStyle="None"
        AllowsTransparency="False">

    <Window.Resources>
        <local:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <local:EqualityToVisibilityConverter x:Key="EqualityToVisibilityConverter"/>
    </Window.Resources>

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="32" ResizeBorderThickness="5" GlassFrameThickness="0" CornerRadius="0"/>
    </WindowChrome.WindowChrome>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Custom Title Bar -->
        <Border Background="#141724" Height="32" BorderBrush="#30363D" BorderThickness="0,0,0,1">
            <Grid>
                <StackPanel Orientation="Horizontal" Margin="15,0,0,0">
                    <Image Source="/Resources/sleipnir_logo.png" Height="16" Width="16" Margin="0,0,8,0"/>
                    <TextBlock Text="Sleipnir | Issue Details" VerticalAlignment="Center" Foreground="#8B949E" FontSize="12"/>
                </StackPanel>
                <StackPanel HorizontalAlignment="Right" Orientation="Horizontal" WindowChrome.IsHitTestVisibleInChrome="True">
                    <Button Content="âœ•" Style="{StaticResource WindowCloseButton}" Click="Close_Click"/>
                </StackPanel>
            </Grid>
        </Border>

        <ScrollViewer Grid.Row="1" Padding="30" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <!-- Title Row -->
                <TextBlock Text="PILLAR / MAIN TITLE" FontSize="11" FontWeight="Bold" Foreground="#7C4DFF" Margin="0,0,0,8"/>
                <TextBox Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}" 
                         FontSize="20" FontWeight="Bold" Background="#2A2F45" BorderThickness="0" Padding="10" Foreground="White" Margin="0,0,0,20"/>

                
                <Grid Margin="0,0,0,30">
                    <StackPanel Orientation="Horizontal">
                        <Border Background="#337C4DFF" CornerRadius="4" Padding="8,4" Margin="0,0,10,0">
                            <TextBlock Text="{Binding Type}" Foreground="#7C4DFF" FontWeight="Bold" FontSize="11"/>
                        </Border>
                        <Border Background="#2A2F45" CornerRadius="4" Padding="8,4">
                            <TextBlock Text="{Binding Status}" Foreground="#E0E0E0" FontSize="11"/>
                        </Border>
                    </StackPanel>
                </Grid>

                <Grid Margin="0,0,0,30">
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Type}" Value="Idea">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Type}" Value="Story">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel>
                        <TextBlock Text="Priority" Foreground="#8B949E" Margin="0,0,0,8"/>
                        <ComboBox ItemsSource="{Binding DataContext.Priorities, RelativeSource={RelativeSource AncestorType=Window}}"
                                  SelectedItem="{Binding Priority}"
                                  Background="#2A2F45" BorderThickness="0" Padding="10"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Responsible Users" Foreground="#8B949E" Margin="0,0,0,8"/>
                        <TextBox Text="{Binding ResponsibleUsers, UpdateSourceTrigger=PropertyChanged}" 
                                 Background="#2A2F45" BorderThickness="0" Padding="10" Foreground="White"
                                 ToolTip="Enter names separated by semicolon"/>
                    </StackPanel>
                </Grid>

                <TextBlock Text="THE IDEA" FontSize="11" FontWeight="Bold" Foreground="#7C4DFF" Margin="0,0,0,8"/>
                <TextBox Text="{Binding LongDescription, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                         Background="#2A2F45" BorderThickness="0" Padding="15" Foreground="White" 
                         Height="200" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"
                         Margin="0,0,0,30"/>

                <!-- Hierarchy / Linking -->
                <Border Background="#1A1D2E" CornerRadius="8" Padding="20">
                    <StackPanel>
                        <!-- Ideas: List of linked stories -->
                        <StackPanel Visibility="{Binding Type, Converter={StaticResource EqualityToVisibilityConverter}, ConverterParameter=Idea}">
                             <TextBlock Text="LINKED EXECUTION STORIES" FontSize="11" FontWeight="Bold" Foreground="#7C4DFF" Margin="0,0,0,15"/>
                             <ItemsControl ItemsSource="{Binding Children}" Margin="0,0,0,10">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#2A2F45" Margin="0,0,0,4" Padding="10,6" CornerRadius="4">
                                            <Border.InputBindings>
                                                <MouseBinding MouseAction="LeftDoubleClick" 
                                                              Command="{Binding ViewModel.JumpToIssueCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                              CommandParameter="{Binding}"/>
                                            </Border.InputBindings>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="{Binding Description}" Foreground="White" FontSize="12" VerticalAlignment="Center" TextWrapping="Wrap"/>
                                                <Border Grid.Column="1" Background="#1A1D2E" CornerRadius="4" Padding="5,2" Margin="10,0,0,0" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding SprintTag}" FontSize="8" Foreground="#8B949E" FontWeight="Bold"/>
                                                </Border>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <Button Command="{Binding ViewModel.AddStoryCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                    CommandParameter="{Binding}"
                                    Style="{StaticResource SidebarButton}" HorizontalAlignment="Left">
                                <TextBlock Text="+ Add New Story" FontSize="10" Foreground="{StaticResource AccentBrush}" FontWeight="Bold"/>
                            </Button>
                        </StackPanel>

                        <!-- Stories / Tasks: Linking to parent Idea -->
                        <StackPanel Visibility="{Binding Type, Converter={StaticResource EqualityToVisibilityConverter}, ConverterParameter=NOT:Idea}">
                            <!-- Current Parent Case -->
                            <StackPanel Visibility="{Binding ParentTitle, Converter={StaticResource NullToVisibilityConverter}}">
                                <TextBlock Text="LINKED STRATEGIC IDEA" FontSize="11" FontWeight="Bold" Foreground="#7C4DFF" Margin="0,0,0,15"/>
                                <Border Background="#2A2F45" Padding="15,12" CornerRadius="8" BorderBrush="#3D7C4DFF" BorderThickness="1">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="ðŸ’¡ " FontSize="16" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding ParentTitle}" Foreground="White" FontSize="14" FontWeight="SemiBold" VerticalAlignment="Center" TextWrapping="Wrap"/>
                                        </StackPanel>
                                        <Button Grid.Column="1" Click="Unlink_Click" Style="{StaticResource SidebarButton}" VerticalAlignment="Center">
                                            <TextBlock Text="Unlink" Foreground="#FF5252" FontWeight="Bold" FontSize="11"/>
                                        </Button>
                                    </Grid>
                                </Border>
                            </StackPanel>

                            <!-- Unlinked Case -->
                            <StackPanel Visibility="{Binding ParentTitle, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Inverse}">
                                <TextBlock Text="ARCHITECTURAL CONNECTION" FontSize="11" FontWeight="Bold" Foreground="#7C4DFF" Margin="0,0,0,15"/>
                                <ToggleButton x:Name="LinkIdeaToggleButton" Style="{StaticResource SidebarToggleButton}" HorizontalAlignment="Left" Padding="15,8">
                                    <TextBlock Text="ðŸ”— Link to Strategic Idea" FontSize="11" Foreground="{StaticResource AccentBrush}" FontWeight="Bold"/>
                                </ToggleButton>
                                <Popup x:Name="LinkIdeaPopup" IsOpen="{Binding IsChecked, ElementName=LinkIdeaToggleButton}" StaysOpen="False" Placement="Bottom" PlacementTarget="{Binding ElementName=LinkIdeaToggleButton}" AllowsTransparency="True">
                                    <Border Background="#1A1D2E" BorderBrush="#30363D" BorderThickness="1" CornerRadius="8" Width="300" MaxHeight="350" Margin="0,5,0,0">
                                        <Grid>
                                             <Grid.RowDefinitions>
                                                 <RowDefinition Height="Auto"/>
                                                 <RowDefinition Height="*"/>
                                             </Grid.RowDefinitions>
                                             <TextBlock Text="Select Strategic Idea" FontSize="10" Foreground="#8B949E" Margin="12,12,12,8" FontWeight="Bold"/>
                                             <ScrollViewer Grid.Row="1" Margin="5">
                                                 <ItemsControl ItemsSource="{Binding ViewModel.PotentialParents, RelativeSource={RelativeSource AncestorType=Window}}">
                                                     <ItemsControl.ItemTemplate>
                                                         <DataTemplate>
                                                             <Button Click="IdeaSelected_Click" Style="{StaticResource SidebarButton}" HorizontalContentAlignment="Left" Padding="10,8" Margin="0,0,0,2">
                                                                 <StackPanel Orientation="Horizontal">
                                                                     <TextBlock Text="ðŸ’¡ " FontSize="12" Opacity="0.7"/>
                                                                     <TextBlock Text="{Binding Description}" Foreground="White" FontSize="12" TextWrapping="Wrap"/>
                                                                 </StackPanel>
                                                             </Button>
                                                         </DataTemplate>
                                                     </ItemsControl.ItemTemplate>
                                                 </ItemsControl>
                                             </ScrollViewer>
                                        </Grid>
                                    </Border>
                                </Popup>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Footer -->
        <Border Grid.Row="2" Background="#141724" Padding="20" BorderBrush="#30363D" BorderThickness="0,1,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="Close" Style="{StaticResource SidebarButton}" Click="Close_Click" Margin="0,0,10,0" Width="100"/>
                <Button Content="Save Changes" Style="{StaticResource AccentButton}" Click="Save_Click" Width="150"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
